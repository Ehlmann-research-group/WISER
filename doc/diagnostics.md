# Diagnostics (working document)

This document contains a collection of snippets and techniques to diagnose bugs
and performance issues in Python programs.

## Debug Seg-Faults in Python

Some libraries, like Qt PySide2 and GDAL, are Python bindings for C/C++ code.
This means it is very possible to generate SIGSEGVs and other faults from buggy
Python code.  To diagnose the cause of such faults, use the built-in Python
[faulthandler](https://docs.python.org/3/library/faulthandler.html) module.

    import faulthandler

    # At the start of the program, do this:
    faulthandler.enable()

When faults occur, you will get a nice Python stack trace.  If you're lucky,
the stack trace will show you exactly what the problem is.

## Profile a Python Program

To run the Python [cProfile]() profiler on `program.py`, storing the profile
data into a file `profile_stats`:

    python -m cProfile -o profile_stats program.py

### Dump Profile Data - Programmatically

To programmatically load the `profile_stats` file generated by the previous
command, e.g. in the Python console or in application code, this approach can be
used:

    import pstats
    from pstats import SortKey
    p = pstats.Stats('profile_stats')

    # Sort by total time spent in each function's code, and print the top 40 results
    p.strip_dirs().sort_stats(SortKey.TIME).print_stats(40)

    # Sort by the cumulative time spent in each function and what it calls, and print the top 40 results
    p.strip_dirs().sort_stats(SortKey.CUMULATIVE).print_stats(40)

Note that stripping the directories can create inaccurate results if the same
module name and function name are used in different directories.

### Dump Profile Data - Utility

The `pstats` module can also be run from the command-line, like this:

    python -m pstats

Once the program is started, various commands can be typed at the `%` command
prompt.  The `help` command can always be used to learn more about what options
are available.

Read in the data file named `profile_stats`:

    % read profile_stats

Sort by total time spent in each function's code:

    profile_stats% sort time

Sort by cumulative time spent in each function and what it calls:

    profile_stats% sort cumulative

Print out all statistics:

    profile_stats% stats

Only print the top 40 results:

    profile_stats% stats 40

## Programatically List All Installed Packages with Versions

To list all installed packages and their working versions:

    import pkg_resources
    installed_packages = [(d.project_name, d.version) for d in pkg_resources.working_set]

This will
