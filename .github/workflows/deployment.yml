name: wiser-build-and-release

on:
  push:
    tags: ["v*"]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  CONDA_ENV: wiser-source
  APP_NAME: WISER

jobs:
  build:
    name: Build (${{ matrix.label }})
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-13
            label: macOS Intel (x86_64)
            arch: x86_64
          - os: macos-14
            label: macOS Apple Silicon (arm64)
            arch: arm64
          - os: windows-latest
            label: Windows (x86_64)
            arch: x86_64
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up micromamba (conda env)
        uses: mamba-org/setup-micromamba@v1
        with:
          environment-file: etc/wiser-source.yml
          cache-environment: true
          cache-downloads: true
          init-shell: bash
          # We'll call the env explicitly via `micromamba run -n $CONDA_ENV`

      # --- macOS code signing / notarization prep ---
      - name: macOS • Import signing certificate
        if: runner.os == 'macOS'
        env:
          MAC_CERT_P12_BASE64: ${{ secrets.MAC_CERT_P12_BASE64 }}
          MAC_CERT_PASSWORD:   ${{ secrets.MAC_CERT_PASSWORD }}
          KEYCHAIN_PASSWORD:   ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          echo "$MAC_CERT_P12_BASE64" | base64 --decode > cert.p12
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security import cert.p12 -k build.keychain -P "$MAC_CERT_PASSWORD" -A
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" build.keychain
          rm -f cert.p12

      - name: macOS • Write Secret.mk + Apple API key
        if: runner.os == 'macOS'
        env:
          # If your Makefile still references these, we provide them.
          AD_USERNAME: ${{ secrets.AD_USERNAME }}
          AD_TEAM_ID:  ${{ secrets.AD_TEAM_ID }}
          AD_PASSWORD: ${{ secrets.AD_PASSWORD }}

          # Preferred notarytool API credentials (issuer/key-id/key file)
          APPLE_ISSUER_ID:       ${{ secrets.APPLE_ISSUER_ID }}
          APPLE_KEY_ID:          ${{ secrets.APPLE_KEY_ID }}
          APPLE_API_KEY_BASE64:  ${{ secrets.APPLE_API_KEY_BASE64 }}
        run: |
          umask 077
          printf "export AD_USERNAME := %s\nexport AD_TEAM_ID := %s\nexport AD_PASSWORD := %s\n" \
            "${AD_USERNAME}" "${AD_TEAM_ID}" "${AD_PASSWORD}" > Secret.mk
          # Create AuthKey.p8 used by notarytool API flow
          echo "$APPLE_API_KEY_BASE64" | base64 --decode > AuthKey.p8

      # --- Windows build prerequisites (Make + NSIS) ---
      - name: Windows • Install build tools (make, nsis)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          choco install -y make nsis

      # --- Build targets (Makefile drives everything) ---
      - name: Build (macOS)
        if: runner.os == 'macOS'
        shell: bash
        env:
          # For notarytool API flow in your Makefile:
          NOTARY_ISSUER:   ${{ secrets.APPLE_ISSUER_ID }}
          NOTARY_KEY_ID:   ${{ secrets.APPLE_KEY_ID }}
          NOTARY_KEY_FILE: AuthKey.p8
          # If your sign_wiser.sh expects an identity:
          MAC_SIGN_IDENTITY: ${{ secrets.MAC_SIGN_IDENTITY }}
        run: |
          micromamba run -n "$CONDA_ENV" make dist-mac

      - name: Build (Windows)
        if: runner.os == 'Windows'
        shell: bash
        env:
          # If your NSIS script uses thumbprint to sign inside the installer:
          SHA1_THUMBPRINT: ${{ secrets.SHA1_THUMBPRINT }}
        run: |
          micromamba run -n "$CONDA_ENV" make dist-win

      # --- Publish CI artifacts for inspection and handoff ---
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ runner.os }}-${{ matrix.arch }}
          path: |
            dist/**/*.dmg
            dist/**/*.zip
            dist/**/*.exe
            dist/**/*.msi
            dist/**/*.app
          retention-days: 14

  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: Create/Update release and upload assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ github.ref_name }}
        run: |
          gh release view "$TAG" >/dev/null 2>&1 || gh release create "$TAG" -t "$TAG" --notes "Automated build"
          gh release upload "$TAG" artifacts/** --clobber
